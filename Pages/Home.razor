@page "/"
@inject IJSRuntime JSRuntime

<PageTitle>Ariel - Mermaid Previewer</PageTitle>

<div class="editor-container">
    <div class="editor-pane">
        <div class="pane-header">
            <h2>Markdown Editor</h2>
            <div class="example-buttons">
                <button @onclick="LoadFlowchartExample" class="btn btn-sm">Flowchart</button>
                <button @onclick="LoadSequenceExample" class="btn btn-sm">Sequence</button>
                <button @onclick="LoadClassExample" class="btn btn-sm">Class</button>
                <button @onclick="LoadPieExample" class="btn btn-sm">Pie Chart</button>
                <button @onclick="LoadGanttExample" class="btn btn-sm">Gantt</button>
            </div>
        </div>
        <textarea @bind="markdownInput" @bind:event="oninput" 
                  @bind:after="OnInputChanged"
                  class="markdown-editor" 
                  placeholder="Enter your markdown with mermaid diagrams here..."></textarea>
    </div>
    <div class="preview-pane">
        <div class="pane-header">
            <h2>Preview</h2>
            <div class="export-buttons">
                <button @onclick="ExportSvg" class="btn btn-sm">SVG</button>
                <button @onclick="ExportPng" class="btn btn-sm">PNG</button>
            </div>
        </div>
        <div id="mermaid-preview" class="preview-content"></div>
    </div>
</div>

@code {
    private string markdownInput = @"# Example Diagram

```mermaid
graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Option 1]
    B -->|No| D[Option 2]
```";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFromLocalStorage();
            await RenderMermaid();
        }
    }

    private async Task OnInputChanged()
    {
        await SaveToLocalStorage();
        await RenderMermaid();
    }

    private async Task RenderMermaid()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("renderMermaid", markdownInput);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering mermaid: {ex.Message}");
        }
    }

    private async Task LoadFromLocalStorage()
    {
        try
        {
            var stored = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "ariel-markdown");
            if (!string.IsNullOrEmpty(stored))
            {
                markdownInput = stored;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from localStorage: {ex.Message}");
        }
    }

    private async Task SaveToLocalStorage()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "ariel-markdown", markdownInput);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving to localStorage: {ex.Message}");
        }
    }

    private async Task ExportSvg()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("exportDiagramAsSvg");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting SVG: {ex.Message}");
        }
    }

    private async Task ExportPng()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("exportDiagramAsPng");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PNG: {ex.Message}");
        }
    }

    private async Task LoadFlowchartExample()
    {
        markdownInput = @"# Flowchart Example

```mermaid
graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process A]
    B -->|No| D[Process B]
    C --> E[End]
    D --> E
```";
        await OnInputChanged();
    }

    private async Task LoadSequenceExample()
    {
        markdownInput = @"# Sequence Diagram Example

```mermaid
sequenceDiagram
    participant A as Alice
    participant B as Bob
    A->>B: Hello Bob, how are you?
    B-->>A: Great thanks!
    A-)B: See you later!
```";
        await OnInputChanged();
    }

    private async Task LoadClassExample()
    {
        markdownInput = @"# Class Diagram Example

```mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
```";
        await OnInputChanged();
    }

    private async Task LoadPieExample()
    {
        markdownInput = @"# Pie Chart Example

```mermaid
pie title Favorite Programming Languages
    ""JavaScript"" : 35
    ""Python"" : 25
    ""C#"" : 20
    ""Java"" : 15
    ""Other"" : 5
```";
        await OnInputChanged();
    }

    private async Task LoadGanttExample()
    {
        markdownInput = @"# Gantt Chart Example

```mermaid
gantt
    title Project Timeline
    dateFormat  YYYY-MM-DD
    section Planning
    Requirements    :done, req, 2024-01-01, 2024-01-07
    Design         :done, design, after req, 5d
    section Development
    Backend        :active, backend, 2024-01-15, 10d
    Frontend       :frontend, after backend, 8d
    Testing        :testing, after frontend, 5d
```";
        await OnInputChanged();
    }
}
